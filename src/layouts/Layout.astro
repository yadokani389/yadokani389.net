---
import "@fontsource/fredoka/latin-400.css";
import "@fontsource/fredoka/latin-500.css";
import "@fontsource/fredoka/latin-600.css";
import "@fontsource/fredoka/latin-700.css";
import "@fontsource/jetbrains-mono/latin-400.css";
import "@fontsource/jetbrains-mono/latin-500.css";
import "@fontsource/jetbrains-mono/latin-600.css";
import "@fontsource/m-plus-rounded-1c/latin-400.css";
import "@fontsource/m-plus-rounded-1c/latin-500.css";
import "@fontsource/m-plus-rounded-1c/latin-700.css";
import "@fontsource/m-plus-rounded-1c/japanese-400.css";
import "@fontsource/m-plus-rounded-1c/japanese-500.css";
import "@fontsource/m-plus-rounded-1c/japanese-700.css";
import { SITE_DESCRIPTION, SITE_TITLE, SITE_URL } from "../consts";
import {
  OG_IMAGE_VERSION,
  OG_DEFAULT_IMAGE_PATH,
  STATIC_OG_IMAGE_BY_PATH,
} from "../seo/pageMeta";
import { daisyThemes, darkThemeModes } from "../lib/daisyThemes";
import SiteFooter from "../components/layout/SiteFooter.astro";
import SiteHeader from "../components/layout/SiteHeader.astro";
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  ogType?: "website" | "article";
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
}

const {
  title,
  description,
  ogImage,
  ogType = "website",
  publishedTime,
  modifiedTime,
  tags = [],
} = Astro.props as Props;
const pageTitle = title ? `${title} | ${SITE_TITLE}` : SITE_TITLE;
const pageDescription = description ?? SITE_DESCRIPTION;
const site = Astro.site ?? new URL(SITE_URL);
const pathname = Astro.url.pathname;
const normalizedPath =
  pathname !== "/" && pathname.endsWith("/") ? pathname.slice(0, -1) : pathname;
const canonicalUrl = new URL(pathname, site).toString();
const dynamicPathPrefixes = ["/blog/", "/works/"];
const isDynamicOgPath = dynamicPathPrefixes.some((prefix) =>
  normalizedPath.startsWith(prefix),
);
const ogImagePath = isDynamicOgPath
  ? `/open-graph${normalizedPath}.png`
  : (STATIC_OG_IMAGE_BY_PATH[normalizedPath] ?? OG_DEFAULT_IMAGE_PATH);
const ogImageResolvedUrl = new URL(ogImage ?? ogImagePath, site);
ogImageResolvedUrl.searchParams.set("v", OG_IMAGE_VERSION);
const ogImageUrl = ogImageResolvedUrl.toString();
const navItems = [
  { href: "/", label: "Home" },
  { href: "/blog", label: "Blog" },
  { href: "/works", label: "Works" },
  { href: "/about", label: "About" },
];
const themeStorageKey = "theme-preference";
const defaultThemeMode = "retro";
const themeModes = ["system", ...daisyThemes];
const formatThemeLabel = (theme: string) =>
  theme
    .split("-")
    .map((part) => `${part.slice(0, 1).toUpperCase()}${part.slice(1)}`)
    .join(" ");
const themeModeOptions = themeModes.map((theme) => ({
  value: theme,
  label: formatThemeLabel(theme),
}));
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <script
      is:inline
      define:vars={{
        daisyThemes,
        darkThemeModes,
        themeStorageKey,
        defaultThemeMode,
      }}
    >
      (() => {
        const resolveTheme = (mode, prefersDark) =>
          mode === "system" ? (prefersDark ? "dark" : "light") : mode;
        const resolveColorScheme = (mode, prefersDark) =>
          mode === "system"
            ? prefersDark
              ? "dark"
              : "light"
            : darkThemeModes.includes(mode)
              ? "dark"
              : "light";
        const isValidMode = (mode) =>
          mode === "system" || daisyThemes.includes(mode);

        let initialMode = defaultThemeMode;
        try {
          const storedMode = localStorage.getItem(themeStorageKey);
          initialMode = isValidMode(storedMode) ? storedMode : defaultThemeMode;
        } catch {
          initialMode = defaultThemeMode;
        }

        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const initialTheme = resolveTheme(initialMode, prefersDark);
        const initialColorScheme = resolveColorScheme(initialMode, prefersDark);

        document.documentElement.setAttribute("data-theme", initialTheme);
        document.documentElement.dataset.themeMode = initialMode;
        document.documentElement.dataset.colorScheme = initialColorScheme;
      })();
    </script>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="canonical" href={canonicalUrl} />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={SITE_TITLE} />
    <meta property="og:locale" content="ja_JP" />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={pageTitle} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={pageTitle} />
    {
      ogType === "article" && publishedTime && (
        <meta property="article:published_time" content={publishedTime} />
      )
    }
    {
      ogType === "article" && modifiedTime && (
        <meta property="article:modified_time" content={modifiedTime} />
      )
    }
    {
      ogType === "article" &&
        tags.map((tag) => <meta property="article:tag" content={tag} />)
    }
  </head>
  <body>
    <a
      class="sr-only focus:not-sr-only focus:absolute focus:left-6 focus:top-6 focus:z-50 focus:rounded-full focus:bg-sand-50 focus:px-4 focus:py-2 focus:text-sm focus:font-semibold focus:text-ink-900 focus:shadow-soft focus:ring-2 focus:ring-sage-500/40"
      href="#main">本文へスキップ</a
    >
    <SiteHeader
      siteTitle={SITE_TITLE}
      normalizedPath={normalizedPath}
      {navItems}
      defaultThemeLabel={formatThemeLabel(defaultThemeMode)}
      {themeModeOptions}
    />
    <main id="main" class="flex-1 px-6 pb-20 pt-8">
      <slot />
    </main>
    <SiteFooter siteTitle={SITE_TITLE} />
    <script
      is:inline
      id="theme-picker-config"
      type="application/json"
      set:html={JSON.stringify({
        daisyThemes,
        darkThemeModes,
        themeStorageKey,
        defaultThemeMode,
      }).replaceAll("<", "\\u003c")}
    />
    <script>
      import {
        bootThemePicker,
        readThemePickerConfig,
      } from "../lib/theme/themePickerClient";
      import { bootCardLinkNavigation } from "../lib/ui/cardLinkClient";

      const config = readThemePickerConfig();
      if (config) {
        bootThemePicker(config);
      }
      bootCardLinkNavigation();
    </script>
  </body>
</html>
